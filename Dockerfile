# escape=`

ARG PARENT_IMAGE
ARG HEADLESS_SERVICES_IMAGE
ARG SPE_IMAGE

FROM ${HEADLESS_SERVICES_IMAGE} AS jss
FROM ${SPE_IMAGE} AS spe
FROM ${PARENT_IMAGE}

# Copy the SPE Module - renamed .dacpac as we use both Sitecore.Core and Sitecore.Security and these changes are related to roles for security
COPY --from=spe [ "C:/module/db/Sitecore.core.dacpac", "C:/resources/spe/Sitecore.Security.dacpac" ]

# Copy the JSS Module (Headless Services) - renamed .dacpac as we use both Sitecore.Core and Sitecore.Security and these changes are related to roles for security
COPY --from=jss [ "C:/module/db/Sitecore.core.dacpac", "C:/resources/jss/Sitecore.Security.dacpac" ]

COPY [ "./resources/", "C:/resources" ]
COPY [ "./scripts/", "C:/" ]

# Overwrite the existing entrypoint 
# - added '-SitecoreAdminEnhancedHashAlgorithm' parameter (true/false) for enhanced security 
#   - see https://doc.sitecore.com/xp/en/developers/102/platform-administration-and-architecture/change-the-hash-algorithm-for-password-encryption.html
# - added '-DatabasesToExclude' parameter to skip schema creation for specified databases, e.g. when Sitecore.Messaging has been replaced by Azure Service Bus.
# - added '-DatabasesEnableContainment' parameter (true/false) to indicate whether to set SQL database containment to partial.
# - added '-SecurityDatabase' parameter (true/false) to indicate whether the security aspects of Sitecore.Core have been moved into Sitecore.Security database
# - modified '-DatabaseUsers' parameter with the basic attribtes being: name, databasename, username, password
#   - attribute 'name' must be left as the standard Sitecore database name, e.g. Sitecore.Core, Sitecore.Master, Sitecore.Web
#   - attribute 'databasename' can be modified to be the actual database name as per any Azure naming convention, e.g. sqldb-uks-prd-scxp1-core.
#   - in this example, we added additional web databases (Sitecore.GeoReplication.Web1, Sitecore.GeoReplication.Web2, Sitecore.GeoReplication.WebShared, Sitecore.Web1, Sitecore.Web) to
#     implement the SQL geo-replication approach plus two publishing targets (Web1 & Web2) that allows for zero downtime during releases ('Stack 1' followed by 'Stack 2'); these link to the 'resources/client_geo_replication' files.
#     - see https://doc.sitecore.com/xp/en/developers/102/platform-administration-and-architecture/walkthrough--replicating-the-web-database-using-azure-active-geo-replication.html
#   - in this example, we added additional attributes for a secondary SQL user (username_secondary + password_secondary) as well as an AAD user (aadUsername + aadUserSID + aadUserType) that
#     has 'db_datareader' access for support purposes; these link to the 'resources/client_new_users' files.
ENTRYPOINT [ "powershell", ".\\StartInit.ps1", "-ResourcesDirectory $env:RESOURCES_PATH", "-SqlServer $env:SQL_SERVER", "-SqlAdminUser $env:SQL_ADMIN_LOGIN", "-SqlAdminPassword $env:SQL_ADMIN_PASSWORD", "-SqlElasticPoolName $env:SQL_ELASTIC_POOL_NAME", "-SitecoreAdminUser $env:SITECORE_ADMIN_USER", "-SitecoreAdminPassword $env:SITECORE_ADMIN_PASSWORD", "-SitecoreAdminEnhancedHashAlgorithm $env:SITECORE_ADMIN_ENHANCED_HASH_ALGORITHM", "-DatabasesToDeploy $env:DATABASES_TO_DEPLOY", "-DatabasesToExclude $env:DATABASES_TO_EXCLUDE", "-DatabasesEnableContainment $env:DATABASES_ENABLE_CONTAINMENT", "-DatabasesScripts $env:DATABASES_SCRIPTS", "-SecurityDatabase $env:SECURITY_DATABASE", "-PostDeploymentWaitPeriod $env:POST_DEPLOYMENT_WAIT_PERIOD", "-DatabaseUsers @( @{ 'name' = 'Sitecore.Core'; 'databasename' = $env:Core_Database_Name; 'username' = $env:Core_Database_Username; 'password' = $env:Core_Database_Password; 'username_secondary' = $env:Core_Database_Username_Secondary; 'password_secondary' = $env:Core_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Exm.Master'; 'databasename' = $env:Exm_Master_Database_Name; 'username' = $env:Exm_Master_Database_Username; 'password' = $env:Exm_Master_Database_Password; 'username_secondary' = $env:Exm_Master_Database_Username_Secondary; 'password_secondary' = $env:Exm_Master_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.ExperienceForms'; 'databasename' = $env:ExperienceForms_Database_Name; 'username' = $env:ExperienceForms_Database_Username; 'password' = $env:ExperienceForms_Database_Password; 'username_secondary' = $env:ExperienceForms_Database_Username_Secondary; 'password_secondary' = $env:ExperienceForms_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.MarketingAutomation'; 'databasename' = $env:Marketing_Automation_Database_Name; 'username' = $env:Marketing_Automation_Database_Username; 'password' = $env:Marketing_Automation_Database_Password; 'username_secondary' = $env:Marketing_Automation_Database_Username_Secondary; 'password_secondary' = $env:Marketing_Automation_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Master'; 'databasename' = $env:Master_Database_Name; 'username' = $env:Master_Database_Username; 'password' = $env:Master_Database_Password; 'username_secondary' = $env:Master_Database_Username_Secondary; 'password_secondary' = $env:Master_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Messaging'; 'databasename' = $env:Messaging_Database_Name; 'username' = $env:Messaging_Database_Username; 'password' = $env:Messaging_Database_Password; 'username_secondary' = $env:Messaging_Database_Username_Secondary; 'password_secondary' = $env:Messaging_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Processing.Engine.Storage'; 'databasename' = $env:Processing_Engine_Storage_Database_Name; 'username' = $env:Processing_Engine_Storage_Database_Username; 'password' = $env:Processing_Engine_Storage_Database_Password; 'username_secondary' = $env:Processing_Engine_Storage_Database_Username_Secondary; 'password_secondary' = $env:Processing_Engine_Storage_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Processing.Engine.Tasks'; 'databasename' = $env:Processing_Engine_Tasks_Database_Name; 'username' = $env:Processing_Engine_Tasks_Database_Username; 'password' = $env:Processing_Engine_Tasks_Database_Password; 'username_secondary' = $env:Processing_Engine_Tasks_Database_Username_Secondary; 'password_secondary' = $env:Processing_Engine_Tasks_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Processing.Pools'; 'databasename' = $env:Processing_Pools_Database_Name; 'username' = $env:Processing_Pools_Database_Username; 'password' = $env:Processing_Pools_Database_Password; 'username_secondary' = $env:Processing_Pools_Database_Username_Secondary; 'password_secondary' = $env:Processing_Pools_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Processing.Tasks'; 'databasename' = $env:Processing_Tasks_Database_Name; 'username' = $env:Processing_Tasks_Database_Username; 'password' = $env:Processing_Tasks_Database_Password; 'username_secondary' = $env:Processing_Tasks_Database_Username_Secondary; 'password_secondary' = $env:Processing_Tasks_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.ReferenceData'; 'databasename' = $env:Reference_Data_Database_Name; 'username' = $env:Reference_Data_Database_Username; 'password' = $env:Reference_Data_Database_Password; 'username_secondary' = $env:Reference_Data_Database_Username_Secondary; 'password_secondary' = $env:Reference_Data_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Reporting'; 'databasename' = $env:Reporting_Database_Name; 'username' = $env:Reporting_Database_Username; 'password' = $env:Reporting_Database_Password; 'username_secondary' = $env:Reporting_Database_Username_Secondary; 'password_secondary' = $env:Reporting_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Security'; 'databasename' = $env:Security_Database_Name; 'username' = $env:Security_Database_Username; 'password' = $env:Security_Database_Password; 'username_secondary' = $env:Security_Database_Username_Secondary; 'password_secondary' = $env:Security_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Web'; 'databasename' = $env:Web_Database_Name; 'username' = $env:Web_Database_Username; 'password' = $env:Web_Database_Password; 'username_secondary' = $env:Web_Database_Username_Secondary; 'password_secondary' = $env:Web_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Xdb.Collection.ShardMapManager'; 'databasename' = $env:Collection_ShardMapManager_Database_Name; 'username' = $env:Collection_ShardMapManager_Database_Username; 'password' = $env:Collection_ShardMapManager_Database_Password; 'username_secondary' = $env:Collection_ShardMapManager_Database_Username_Secondary; 'password_secondary' = $env:Collection_ShardMapManager_Database_Password_Secondary; 'shardMax' = $env:Collection_Shard_Max; 'shardDatabaseNamePrefix' = $env:Collection_Shard_Database_Name_Prefix; 'shardDatabaseNameSuffix' = $env:Collection_Shard_Database_Name_Suffix; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.GeoReplication.Web1'; 'databasename' = $env:GeoReplication_Web1_Database_Name; 'username' = $env:GeoReplication_Web1_Database_Username; 'password' = $env:GeoReplication_Web1_Database_Password; 'username_secondary' = $env:GeoReplication_Web1_Database_Username_Secondary; 'password_secondary' = $env:GeoReplication_Web1_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.GeoReplication.Web2'; 'databasename' = $env:GeoReplication_Web2_Database_Name; 'username' = $env:GeoReplication_Web2_Database_Username; 'password' = $env:GeoReplication_Web2_Database_Password; 'username_secondary' = $env:GeoReplication_Web2_Database_Username_Secondary; 'password_secondary' = $env:GeoReplication_Web2_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.GeoReplication.WebShared'; 'databasename' = $env:GeoReplication_WebShared_Database_Name; 'username' = $env:GeoReplication_WebShared_Database_Username; 'password' = $env:GeoReplication_WebShared_Database_Password; 'username_secondary' = $env:GeoReplication_WebShared_Database_Username_Secondary; 'password_secondary' = $env:GeoReplication_WebShared_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Web1'; 'databasename' = $env:Web1_Database_Name; 'username' = $env:Web1_Database_Username; 'password' = $env:Web1_Database_Password; 'username_secondary' = $env:Web1_Database_Username_Secondary; 'password_secondary' = $env:Web1_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' }, @{ 'name' = 'Sitecore.Web2'; 'databasename' = $env:Web2_Database_Name; 'username' = $env:Web2_Database_Username; 'password' = $env:Web2_Database_Password; 'username_secondary' = $env:Web2_Database_Username_Secondary; 'password_secondary' = $env:Web2_Database_Password_Secondary; 'aadUsername' = $env:AAD_SupportGroup_DisplayName; 'aadUserSID' = $env:AAD_SupportGroup_SID; 'aadUserType' = 'X' })", "-InformationAction Continue" ]
